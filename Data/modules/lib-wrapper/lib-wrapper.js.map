{"version":3,"file":"lib-wrapper.js","sources":["../src/consts.js","../src/utils/misc.js","../src/ui/notifications.js","../src/utils/errors.js","../src/ui/stats.js","../src/lib/wrapper.js","../src/ui/settings.js","../src/lib/lib-wrapper.js"],"sourcesContent":["// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\n//*********************\n// Module information\nexport const MODULE_ID    = 'lib-wrapper';\nexport const MODULE_TITLE = 'libWrapper';\n\n\n//*********************\n// Semantic versioning\n\nexport let VERSION        = '';\nexport let MAJOR_VERSION  = -1;\nexport let MINOR_VERSION  = -1;\nexport let PATCH_VERSION  = -1;\nexport let SUFFIX_VERSION = '';\n\nexport function parse_manifest_version() {\n\tif(VERSION)\n\t\treturn;\n\n\tconst version_str = game.modules?.get(MODULE_ID)?.data?.version;\n\tif(!version_str)\n\t\tthrow `libWrapper: Unable to find version string inside 'game.modules'`;\n\n\tconst match = version_str.match(/^([0-9]+)\\.([0-9]+)\\.([0-9]+)[.-]?(.*)$/i);\n\tif(!match)\n\t\tthrow `libWrapper: Unable to parse version string '${version_str}'`\n\n\tVERSION        = match[0];\n\tMAJOR_VERSION  = parseInt(match[1]);\n\tMINOR_VERSION  = parseInt(match[2]);\n\tPATCH_VERSION  = parseInt(match[3]);\n\tSUFFIX_VERSION = parseInt(match[4]);\n\tif(isNaN(SUFFIX_VERSION)) SUFFIX_VERSION = match[4];\n}\n\n\n//*********************\n// Miscellaneous definitions\nexport const IS_UNITTEST = (typeof Game === 'undefined');\nexport const PROPERTIES_CONFIGURABLE = IS_UNITTEST ? true : false;\n\n\n//*********************\n// Debug\nexport let DEBUG = false;\nexport function setDebug(new_debug) { DEBUG = new_debug; }\n\n\n//*********************\n// TYPES\nexport const TYPES_LIST = ['WRAPPER', 'MIXED', 'OVERRIDE'];\nObject.freeze(TYPES_LIST);\n\nexport const TYPES = {\n\tWRAPPER : 1,\n\tMIXED   : 2,\n\tOVERRIDE: 3\n};\nObject.freeze(TYPES);\n\nexport const TYPES_REVERSE = {};\nfor(let key in TYPES) {\n\tTYPES_REVERSE[TYPES[key]] = key;\n}\nObject.freeze(TYPES_REVERSE);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {IS_UNITTEST, MODULE_ID} from '../consts.js';\n\n\n// Find currently executing module name (that is not libWrapper)\nexport function get_current_module_name() {\n\tconst stack_trace = Error().stack;\n\tif(!stack_trace)\n\t\treturn null;\n\n\tconst matches = stack_trace.matchAll(/(?<=\\/modules\\/).+?(?=\\/)/ig);\n\tif(!matches)\n\t\treturn null;\n\n\tfor(let match of matches) {\n\t\tmatch = match[0];\n\n\t\tif(!match || match == MODULE_ID || !(game?.modules?.has(match) ?? true))\n\t\t\tcontinue;\n\n\t\treturn match;\n\t}\n\n\treturn null;\n}\n\n\n// HACK: The browser doesn't expose all global variables (e.g. 'Game') inside globalThis, but it does to an eval\n// We declare this helper here so that the eval does not have access to the anonymous function scope\nconst __eval_copy = eval;\nexport function get_global_variable(varname) {\n\ttry {\n\t\treturn globalThis[varname] ?? __eval_copy(varname);\n\t}\n\tcatch (e) {\n\t\treturn undefined;\n\t}\n}\n\n\n// Change the name of a function object\n// Note: This is extremely hacky, and only works in some browsers, and only sometimes (usually when a function is anonymous)\nexport function set_function_name(fn, name) {\n\ttry {\n\t\tObject.defineProperty(fn, 'name', {\n\t\t\tvalue: name,\n\t\t\twritable: false,\n\t\t\tenumerable: false,\n\t\t\tconfigurable: true\n\t\t});\n\t}\n\tcatch (e) {\n\t\t// disregard unless this is a unit test - probably unsupported by browser\n\t\tif(IS_UNITTEST)\n\t\t\tthrow e;\n\t}\n}\n\n\n// Shared list of active wrappers\nexport const WRAPPERS = new Set();","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {MODULE_ID} from '../consts.js';\n\n\n// Notify user\nexport class LibWrapperNotifications {\n\tstatic init() {\n\t}\n\n\tstatic get ui_enabled() {\n\t\ttry {\n\t\t\tif(game?.user?.isGM) {\n\t\t\t\tif(!game?.settings?.get(MODULE_ID, 'notify-issues-gm'))\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(!game?.settings?.get(MODULE_ID, 'notify-issues-player'))\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tcatch(e) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tstatic ui(msg, fn='error') {\n\t\tif(!this.ui_enabled)\n\t\t\treturn;\n\n\n\t\t// Check if we've already notified the user of this\n\t\tif(!this.NOTIFICATION_SET)\n\t\t\tthis.NOTIFICATION_SET = new Set();\n\t\telse if(this.NOTIFICATION_SET.has(msg))\n\t\t\treturn;\n\n\t\tthis.NOTIFICATION_SET.add(msg);\n\n\t\t// Notify - ensure that ui.notifications exists as if an error occurs too early it might not be defined yet\n\t\tlet notify = ui?.notifications;\n\t\tif(notify) {\n\t\t\tnotify = notify[fn];\n\n\t\t\tnotify.call(ui.notifications, `libWrapper: ${msg}`, {permanent: fn == 'error'});\n\t\t}\n\t}\n\n\n\tstatic console_ui(ui_msg, console_msg, fn='error') {\n\t\tconsole[fn].call(console, `libWrapper: ${ui_msg}\\n${console_msg}`);\n\n\t\tthis.ui(`${ui_msg} (See JS console)`, fn);\n\t}\n\n\n\tstatic conflict(module, other, potential, console_msg) {\n\t\tif(!module)\n\t\t\tmodule = 'an unknown module';\n\t\telse if(module.startsWith(\"\\u00AB\") && module.endsWith(\"\\u00BB\"))\n\t\t\tmodule = `module ${module}`;\n\t\telse\n\t\t\tmodule = `module '${module}'`;\n\n\t\tif(Array.isArray(other))\n\t\t\tother = (other.length > 1) ? `[${other.join(', ')}]` : `'${other[0]}'`\n\t\telse\n\t\t\tother = `'${other}'`;\n\n\t\tthis.console_ui(\n\t\t\tpotential ? `Potential conflict detected between ${module} and ${other}.` : `Conflict detected between module ${module} and ${other}.`,\n\t\t\tconsole_msg,\n\t\t\tpotential ? 'warn' : 'error'\n\t\t);\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {IS_UNITTEST, MODULE_ID} from '../consts.js';\nimport {get_current_module_name} from './misc.js';\nimport {LibWrapperNotifications} from '../ui/notifications.js';\n\n\n// Custom libWrapper Error\nexport class LibWrapperError extends Error {\n\tconstructor(ui_msg, console_msg, notification_fn, ...args) {\n\t\tsuper(`${ui_msg}\\n${console_msg}`, ...args);\n\n\t\t// Maintains proper stack trace for where our error was thrown (only available on V8)\n\t\tif (Error.captureStackTrace)\n\t\t\tError.captureStackTrace(this, this.constructor);\n\t\tthis.name = this.constructor.name;\n\n\t\t// Store arguments\n\t\tthis.ui_msg = ui_msg;\n\t\tthis.console_msg = console_msg;\n\t\tthis.notification_fn = notification_fn ?? 'error';\n\t}\n\n\t/**\n\t * Called if this error is unhandled\n\t */\n\tonUnhandled() {\n\t}\n}\nObject.freeze(LibWrapperError);\n\n// Internal error\nexport class LibWrapperInternalError extends LibWrapperError {\n\tconstructor(console_msg, ...args) {\n\t\tconst module = get_current_module_name();\n\n\t\tsuper(\n\t\t\tmodule ? `Internal error detected, possibly related to module '${module}'.`\n\t\t\t       : 'Internal error detected.'\n\t\t\t,\n\t\t\tconsole_msg,\n\t\t\t'error',\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis.module = module;\n\t}\n}\nObject.freeze(LibWrapperInternalError);\n\n// Error caused by a module\nexport class LibWrapperModuleError extends LibWrapperError {\n\tconstructor(console_msg, module, ...args) {\n\t\tlet possibly = false;\n\n\t\tif(!module) {\n\t\t\tmodule = module ?? get_current_module_name();\n\t\t\tpossibly = true;\n\t\t}\n\n\t\tsuper(\n\t\t\t(module ? (\n\t\t\t\tpossibly ? `Error detected, possibly in module '${module}'.` :\n\t\t\t\t         `Error detected in module '${module}'.`\n\t\t\t\t) :\n\t\t\t\t'Error detected in unknown module.'\n\t\t\t),\n\t\t\tconsole_msg,\n\t\t\t'error',\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis.module = module;\n\t}\n}\nObject.freeze(LibWrapperModuleError);\n\n// Already Overridden Error\nexport class LibWrapperAlreadyOverriddenError extends LibWrapperError {\n\tconstructor(module, conflicting_module, target, ...args) {\n\t\tsuper(\n\t\t\t`Conflict detected between module '${module}' and '${conflicting_module}'.`,\n\t\t\t`Failed to wrap '${target}' for module '${module}' with type OVERRIDE. The module '${conflicting_module}' has already registered an OVERRIDE wrapper for the same method.`,\n\t\t\t'error',\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis.module = module;\n\t\tthis.conflicting_module = conflicting_module;\n\t\tthis.target = target;\n\t}\n\n\t/**\n\t * Returns the title of the module that caused the wrapping conflict\n\t */\n\tget conflicting_module_title() {\n\t\treturn game.modules.get(this.conflicting_module)?.data?.title;\n\t}\n\n\t/**\n\t * Called if this error is unhandled\n\t */\n\tonUnhandled() {\n\t\tsuper.onUnhandled();\n\n\t\tLibWrapperStats.register_conflict(this.module, this.conflicting_module, this.target);\n\t}\n}\nObject.freeze(LibWrapperAlreadyOverriddenError);\n\n// Invalid Wrapper Chain Error\nexport class LibWrapperInvalidWrapperChainError extends LibWrapperError {\n\tconstructor(wrapper, module, console_msg, ...args) {\n\t\tlet user_msg = (module) ?\n\t\t\t`Error detected in module '${module}'.`:\n\t\t\t`Error detected in wrapper '${wrapper.name}'.`\n\t\t;\n\n\t\tsuper(\n\t\t\tuser_msg,\n\t\t\tconsole_msg,\n\t\t\t'error',\n\t\t\t...args\n\t\t);\n\n\t\t// Custom debugging information\n\t\tthis._wrapper = wrapper;\n\t\tthis.module = module;\n\t}\n\n\tget wrapper_name() {\n\t\treturn this._wrapper.name;\n\t}\n}\nObject.freeze(LibWrapperInvalidWrapperChainError);\n\n\n\n// Listen for unhandled exceptions\nif(!IS_UNITTEST) {\n\tconst onUnhandledError = function(e) {\n\t\tif(!(e instanceof LibWrapperError))\n\t\t\treturn false;\n\n\t\ttry {\n\t\t\tif(e.ui_msg && e.notification_fn)\n\t\t\t\tLibWrapperNotifications.ui(`${e.ui_msg} (See JS console)`, e.notification_fn);\n\n\t\t\tif(e.onUnhandled)\n\t\t\t\te.onUnhandled.apply(e);\n\t\t}\n\t\tcatch (e) {\n\t\t\tconsole.warn('libWrapper: Exception thrown while processing unhandled libWrapper Exception.', e);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tglobalThis.addEventListener('error', onUnhandledError);\n\tglobalThis.addEventListener('unhandledrejection', onUnhandledError);\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {MODULE_ID} from '../consts.js';\n\nexport class LibWrapperStats {\n\tstatic _collect_stats() {\n\t\t// This method is called before game.user initializes, so we need to look at game.data.users manually\n\t\tconst userid = game.userId;\n\t\tif(!userid)\n\t\t\treturn false;\n\n\t\tconst user = game.data.users.find((x) => { return x._id == userid });\n\n\t\tif(!user || user.role !== 4)\n\t\t\treturn false;\n\n\t\treturn true;\n\t}\n\n\tstatic init() {\n\t\tthis.collect_stats = this._collect_stats();\n\n\t\t// If we got this far, we're going to be collecting statistics, so initialize the containers\n\t\tif(!this.collect_stats)\n\t\t\treturn;\n\n\t\tthis.MODULES   = new Set();\n\t\tthis.CONFLICTS = new Map();\n\t}\n\n\tstatic register_module(module) {\n\t\tif(!this.collect_stats)\n\t\t\treturn;\n\n\t\tif(module == MODULE_ID)\n\t\t\treturn;\n\n\t\tthis.MODULES.add(module);\n\t}\n\n\tstatic register_conflict(module, other, target) {\n\t\tif(!this.collect_stats)\n\t\t\treturn;\n\n\t\tif(Array.isArray(other)) {\n\t\t\tother.forEach((m) => {\n\t\t\t\tLibWrapperStats.register_conflict(module, m, target);\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tconst key = `${module}/${other}`;\n\n\t\tlet data = this.CONFLICTS.get(key);\n\t\tif(!data) {\n\t\t\tdata = {\n\t\t\t\tcount: 0,\n\t\t\t\tmodule: module,\n\t\t\t\tother: other,\n\t\t\t\ttargets: new Map()\n\t\t\t};\n\t\t\tthis.CONFLICTS.set(key, data);\n\t\t}\n\n\t\tdata.count++;\n\t\tdata.targets.set(target, (data.targets.get(target) ?? 0) + 1);\n\t}\n\n\tstatic get conflicts() {\n\t\treturn this.CONFLICTS;\n\t}\n\n\tstatic get modules() {\n\t\treturn this.MODULES;\n\t}\n}","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {MODULE_ID, PROPERTIES_CONFIGURABLE, TYPES, DEBUG} from '../consts.js';\nimport {get_current_module_name, set_function_name} from '../utils/misc.js';\nimport {LibWrapperInternalError, LibWrapperModuleError, LibWrapperInvalidWrapperChainError} from '../utils/errors.js';\nimport {LibWrapperNotifications} from '../ui/notifications.js';\nimport {LibWrapperStats} from '../ui/stats.js';\n\n\n// Wrapper class - this class is responsible for the actual wrapping\nexport class Wrapper {\n\t// Properties\n\tget name() {\n\t\treturn this.names[0];\n\t}\n\n\n\n\t// Callstack\n\t_callstack_name(nm, arg1=this.name) {\n\t\treturn `üéÅ${nm}(${arg1})`;\n\t}\n\n\t_callstack_call_wrapper_name(module) {\n\t\treturn `call_wrapper('${module}')`;\n\t}\n\n\n\n\t// Constructor\n\tconstructor (obj, fn_name, name=undefined, module=undefined) {\n\t\t// Basic instance variables\n\t\tthis.fn_name = fn_name;\n\t\tthis.object  = obj;\n\n\t\t// Calidate whether we can wrap this object\n\t\tlet descriptor = Object.getOwnPropertyDescriptor(obj, fn_name);\n\n\t\tif(descriptor) {\n\t\t\tif(descriptor.get?._lib_wrapper) {\n\t\t\t\tlet wrapper = descriptor.get?._lib_wrapper;\n\n\t\t\t\tif(name && !wrapper.names.indexOf(name))\n\t\t\t\t\twrapper.names.push(name);\n\n\t\t\t\tif(wrapper && wrapper instanceof this.constructor)\n\t\t\t\t\treturn wrapper;\n\t\t\t}\n\n\t\t\tif(descriptor.configurable === false) {\n\t\t\t\tthrow new LibWrapperModuleError(`libWrapper: '${name}' cannot be wrapped, the corresponding descriptor has 'configurable=false'.`, module);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(descriptor.get) {\n\t\t\t\t\tthis.is_property = true;\n\t\t\t\t\tthis._wrapped_getter = descriptor.get;\n\t\t\t\t\tthis._wrapped_setter = descriptor.set;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.is_property = false;\n\t\t\t\t\tthis._wrapped = descriptor.value;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tdescriptor = this._get_inherited_descriptor();\n\n\t\t\tif(!descriptor)\n\t\t\t\tthrow new LibWrapperModuleError(`libWrapper: Can't wrap '${name}', target does not exist or could not be found.`, module);\n\n\t\t\tconst wrapper = descriptor.get?._lib_wrapper;\n\n\t\t\tif(wrapper) {\n\t\t\t\tthis.is_property = wrapper.is_property;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(descriptor.get ?? descriptor.set)\n\t\t\t\t\tthis.is_property = true;\n\t\t\t\telse\n\t\t\t\t\tthis.is_property = false;\n\t\t\t}\n\t\t}\n\n\t\t// Setup instance variables\n\t\tthis.names   = [];\n\n\t\tthis.getter_data = [];\n\t\tif(this.is_property)\n\t\t\tthis.setter_data = [];\n\n\t\tthis.active  = false;\n\n\t\tthis._outstanding_wrappers = 0;\n\t\tthis._warned_detected_classic_wrapper = false;\n\n\t\tif(!this.is_property) {\n\t\t\tthis._pending_original_calls = [];\n\t\t\tthis._setter_call_count = 0;\n\t\t}\n\n\t\t// Add name\n\t\tif(!name)\n\t\t\tname = fn_name;\n\n\t\tif(this.names.indexOf(name) == -1)\n\t\t\tthis.names.push(name);\n\n\t\t// Do actual wrapping\n\t\tthis._wrap();\n\t}\n\n\n\n\t// Wrap/unwrap logic\n\t_get_handler() {\n\t\t// We use a trick here to be able to convince the browser to name the method the way we want it\n\t\tconst _this = this;\n\t\tconst setter_call_count = this._setter_call_count;\n\t\tconst handler_nm = this._callstack_name(`@handler${setter_call_count}`);\n\t\tconst wrapped = this._wrapped;\n\n\t\tconst obj = {\n\t\t\t[handler_nm]: function(...args) {\n\t\t\t\tif(_this.should_skip_wrappers(this, setter_call_count)) {\n\t\t\t\t\treturn _this.get_wrapped.call(_this, this, false, wrapped).apply(this, args);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tconst fn = _this.call_wrapper.bind(_this, null, this);\n\t\t\t\t\tset_function_name(fn, _this._callstack_call_wrapper_name('<start>'));\n\t\t\t\t\treturn fn(...args);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\treturn obj[handler_nm];\n\t}\n\n\t_wrap() {\n\t\tif(this.active)\n\t\t\treturn;\n\n\t\t// Setup setter/getter\n\t\t// We use a trick here to be able to convince the browser to name the method the way we want it\n\t\tconst getter_nm = this._callstack_name('@getter');\n\t\tconst setter_nm = this._callstack_name('@setter');\n\t\tlet obj;\n\n\t\tif(!this.is_property) {\n\t\t\tconst _this = this;\n\n\t\t\t// Setup setter / getter\n\t\t\tobj = {\n\t\t\t\t[getter_nm]: function() {\n\t\t\t\t\treturn _this._get_handler();\n\t\t\t\t},\n\n\t\t\t\t[setter_nm]: function(value) {\n\t\t\t\t\treturn _this.set_nonproperty(value, this);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\t// Setup setter / getter\n\t\t\tconst _this = this;\n\n\t\t\tobj = {\n\t\t\t\t[getter_nm]: function(...args) {\n\t\t\t\t\treturn _this.call_wrapper(null, this, ...args);\n\t\t\t\t},\n\n\t\t\t\t[setter_nm]: function(...args) {\n\t\t\t\t\treturn _this.call_wrapper({setter: true}, this, ...args);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst getter = obj[getter_nm];\n\t\tconst setter = obj[setter_nm];\n\n\t\t// Store a reference to this in the getter so that we can support 'singleton'-like functionality\n\t\tgetter._lib_wrapper = this;\n\n\t\t// Define a property with a getter/setter\n\t\tObject.defineProperty(this.object, this.fn_name, {\n\t\t\tget: getter,\n\t\t\tset: setter,\n\t\t\tconfigurable: PROPERTIES_CONFIGURABLE\n\t\t});\n\n\t\tthis.active = true;\n\n\t\tconsole.debug(`libWrapper: Wrapped '${this.name}'.`);\n\t}\n\n\tunwrap() {\n\t\tif(!this.active)\n\t\t\treturn;\n\n\t\tif(!PROPERTIES_CONFIGURABLE)\n\t\t\tthrow new LibWrapperInternalError('libWrapper: Cannot unwrap when PROPERTIES_CONFIGURABLE==false');\n\n\n\t\t// Remove the property\n\t\tdelete this.object[this.fn_name];\n\n\t\tif(this.is_property) {\n\t\t\tObject.defineProperty(this.object, this.fn_name, {\n\t\t\t\tget: this._wrapped_getter,\n\t\t\t\tset: this._wrapped_setter,\n\t\t\t\tconfigurable: true\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tthis.object[this.fn_name] = this._wrapped;\n\t\t}\n\n\n\t\t// Done\n\t\tthis.active = false;\n\n\t\tconsole.debug(`libWrapper: Unwrapped '${this.name}'.`);\n\t}\n\n\n\n\t// Utilities related to getting the wrapped value\n\t_get_inherited_descriptor() {\n\t\tlet iObj = Object.getPrototypeOf(this.object);\n\t\tlet descriptor = null;\n\n\t\twhile(iObj) {\n\t\t\tdescriptor = Object.getOwnPropertyDescriptor(iObj, this.fn_name);\n\t\t\tif(descriptor)\n\t\t\t\treturn descriptor;\n\n\t\t\tiObj = Object.getPrototypeOf(iObj);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tget_wrapped(obj, setter=false, wrapped=this._wrapped) {\n\t\tlet result;\n\n\t\t// Properties return the getter or setter, depending on what is requested\n\t\tif(this.is_property)\n\t\t\tresult = setter ? this._wrapped_setter : this._wrapped_getter;\n\t\telse\n\t\t\tresult = wrapped;\n\n\t\t// If this wrapper is 'empty', we need to search up the inheritance hierarchy for the return value\n\t\tif(result === undefined) {\n\t\t\tconst descriptor = this._get_inherited_descriptor();\n\n\t\t\tif(descriptor) {\n\t\t\t\tif(this.is_property) {\n\t\t\t\t\tif(!(descriptor.get ?? descriptor.set))\n\t\t\t\t\t\tthrow new LibWrapperInternalError(`This wrapper is set up to wrap a property, but the inherited descriptor is a method.`);\n\n\t\t\t\t\tif(setter)\n\t\t\t\t\t\tresult = descriptor.set;\n\t\t\t\t\telse\n\t\t\t\t\t\tresult = descriptor.get;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tresult = descriptor.value ?? descriptor.get.apply(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Done\n\t\tif(result === undefined)\n\t\t\tconsole.warn(`libWrapper: There is no wrapped method for '${this.name}', returning 'undefined'.`);\n\n\t\treturn result;\n\t}\n\n\n\n\t// Calling the wrapped method\n\t_call_wrapped(obj, args, is_setter=false) {\n\t\tlet pend;\n\n\t\tif(!this.is_property) {\n\t\t\t// Set this wrapped call as pending\n\t\t\tpend = obj;\n\t\t\tthis._pending_original_calls.push(pend);\n\t\t}\n\n\n\t\t// Try-catch block to handle normal exception flow\n\t\tlet result = undefined;\n\t\ttry {\n\t\t\tconst wrapped = this.get_wrapped(this.object, is_setter);\n\t\t\tresult = wrapped?.apply(obj, args);\n\t\t}\n\t\tcatch(e) {\n\t\t\tif(!this.is_property)\n\t\t\t\tthis._cleanup_call_wrapped(null, pend);\n\n\t\t\tthrow e;\n\t\t}\n\n\t\t// We only need to keep track of pending calls when we're not wrapping a property\n\t\tif(this.is_property)\n\t\t\treturn result;\n\n\t\t// If the result is a Promise, then we must wait until it fulfills before cleaning up.\n\t\t// Per the JS spec, the only way to detect a Promise (since Promises can be polyfilled, extended, wrapped, etc) is to look for the 'then' method.\n\t\t// Anything with a 'then' function is technically a Promise. This leaves a path for false-positives, but I don't see a way to avoid this.\n\t\tif(typeof result?.then === 'function') {\n\t\t\tresult = result.then(\n\t\t\t\t// onResolved\n\t\t\t\tv => this._cleanup_call_wrapped(v, pend),\n\t\t\t\t// onRejected\n\t\t\t\te => {\n\t\t\t\t\tthis._cleanup_call_wrapped(null, pend);\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t\t// Otherwise, we can immediately cleanup.\n\t\telse {\n\t\t\tresult = this._cleanup_call_wrapped(result, pend);\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\t_cleanup_call_wrapped(result, pend) {\n\t\tconst pend_i = this._pending_original_calls.indexOf(pend);\n\t\tif(pend_i < 0)\n\t\t\tthrow new LibWrapperInternalError(`Could not find 'pend' inside 'this._pending_original_calls'.`);\n\n\t\tthis._pending_original_calls.splice(pend_i, 1);\n\n\t\treturn result;\n\t}\n\n\tshould_skip_wrappers(obj, setter_call_count) {\n\t\t// We don't need to skip wrappers if the wrapper reference was generated after the last setter call\n\t\tif(setter_call_count == this._setter_call_count)\n\t\t\treturn false;\n\n\t\t// Sanity check\n\t\tif(setter_call_count > this._setter_call_count)\n\t\t\tthrow new LibWrapperInternalError(`Unreachable: setter_call_count=${setter_call_count} > this._setter_call_count=${this._setter_call_count}`);\n\n\t\t// Find pending calls that match this object - if any is found, skip wrappers\n\t\tconst pend_i = this._pending_original_calls.indexOf(obj);\n\t\tif(pend_i < 0)\n\t\t\treturn false;\n\n\t\treturn true;\n\t}\n\n\n\n\t// Main call wrapper logic\n\tcall_wrapper(state, obj, ...args) {\n\t\t// Set up basic information about this wrapper\n\t\tconst index = state?.index ?? 0;\n\t\tconst is_setter = state?.setter ?? false;\n\t\tconst fn_data = state?.fn_data ?? (is_setter ? this.setter_data : this.getter_data);\n\n\t\t// Keep track of call state\n\t\tif(state) {\n\t\t\tif('valid' in state && !state.valid) {\n\t\t\t\tthrow new LibWrapperInvalidWrapperChainError(\n\t\t\t\t\tthis,\n\t\t\t\t\tstate.prev_data?.module,\n\t\t\t\t\t`This wrapper function for '${this.name}' is no longer valid, and must not be called.`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tstate.called = true;\n\t\t}\n\n\t\t// Grab the next function data from the function data array\n\t\tconst data = fn_data[index];\n\n\t\t// If no more methods exist, then finish the chain\n\t\tif(!data) {\n\t\t\t// We've finished all wrappers. Return the wrapped value.\n\t\t\treturn this._call_wrapped(obj, args, is_setter);\n\t\t}\n\n\t\t// Grab wrapper function from function data object\n\t\tconst fn = data.fn;\n\n\t\t// OVERRIDE type does not continue the chain\n\t\tif(data.type >= TYPES.OVERRIDE) {\n\t\t\t// Call next method in the chain\n\t\t\treturn fn.apply(obj, args);\n\t\t}\n\n\t\t// Prepare the continuation of the chain\n\t\tconst next_state = {\n\t\t\tsetter   : is_setter,\n\t\t\tcalled   : false,\n\t\t\tvalid    : true,\n\t\t\tindex    : index + 1,\n\t\t\tprev_data: data,\n\t\t\tfn_data  : fn_data\n\t\t};\n\n\t\t// Create the next wrapper function\n\t\tconst next_fn = this.call_wrapper.bind(this, next_state, obj);\n\t\tset_function_name(next_fn, this._callstack_call_wrapper_name(fn_data[next_state.index]?.module ?? '<finish>'));\n\t\tthis._outstanding_wrappers++;\n\n\n\t\t// Try-catch block to handle normal exception flow\n\t\tlet result = undefined;\n\t\ttry {\n\t\t\t// Call next method in the chain\n\t\t\tresult = fn.call(obj, next_fn, ...args);\n\t\t}\n\t\tcatch(e) {\n\t\t\treturn this._cleanup_call_wrapper_thrown(next_state, e);\n\t\t}\n\n\t\t// If the result is a Promise, then we must wait until it fulfills before cleaning up.\n\t\t// Per the JS spec, the only way to detect a Promise (since Promises can be polyfilled, extended, wrapped, etc) is to look for the 'then' method.\n\t\t// Anything with a 'then' function is technically a Promise. This leaves a path for false-positives, but I don't see a way to avoid this.\n\t\tif(typeof result?.then === 'function') {\n\t\t\tresult = result.then(\n\t\t\t\t// onResolved\n\t\t\t\tv => this._cleanup_call_wrapper(v, next_state, data, fn_data, next_fn, obj, ...args),\n\t\t\t\t// onRejected\n\t\t\t\te => this._cleanup_call_wrapper_thrown(next_state, e)\n\t\t\t);\n\t\t}\n\t\t// Otherwise, we can immediately cleanup.\n\t\telse {\n\t\t\tresult = this._cleanup_call_wrapper(result, next_state, data, fn_data, next_fn, obj, ...args);\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\t_invalidate_state(state) {\n\t\tstate.valid = false;\n\n\t\tthis._outstanding_wrappers--;\n\t\tif(this._outstanding_wrappers < 0)\n\t\t\tthrow new LibWrapperInternalError(`Outstanding wrappers = ${this._outstanding_wrappers}, should never fall below 0.`);\n\t}\n\n\t_cleanup_call_wrapper_thrown(next_state, e) {\n\t\t// An exception/rejection causes invalidation of next_state\n\t\tthis._invalidate_state(next_state);\n\n\t\t// Re-throw\n\t\tthrow e;\n\t}\n\n\t_cleanup_call_wrapper(result, next_state, data, fn_data, next_fn, obj, ...args) {\n\t\t// Try-finally to ensure we invalidate the wrapper even if this logic fails\n\t\ttry {\n\t\t\t// Check that next_fn was called\n\t\t\tif(!next_state.called) {\n\t\t\t\t// We need to collect affected modules information if we're collecting statistics, or we haven't warned the user of this conflict yet.\n\t\t\t\tlet collect_affected = (!data.warned_conflict || LibWrapperStats.collect_stats);\n\t\t\t\tlet affectedModules = null;\n\t\t\t\tlet is_last_wrapper = false;\n\n\t\t\t\tif(collect_affected) {\n\t\t\t\t\taffectedModules = fn_data.slice(next_state.index).filter((x) => {\n\t\t\t\t\t\treturn x.module != data.module;\n\t\t\t\t\t}).map((x) => {\n\t\t\t\t\t\treturn x.module;\n\t\t\t\t\t});\n\n\t\t\t\t\tis_last_wrapper = (affectedModules.length == 0);\n\n\t\t\t\t\tLibWrapperStats.register_conflict(data.module, affectedModules, this.name);\n\t\t\t\t}\n\n\t\t\t\t// WRAPPER-type functions that do this are breaking an API requirement, as such we need to be loud about this.\n\t\t\t\t// As a \"punishment\" of sorts, we forcefully unregister them and ignore whatever they did.\n\t\t\t\tif(data.type == TYPES.WRAPPER) {\n\t\t\t\t\tLibWrapperNotifications.console_ui(\n\t\t\t\t\t\t`Error detected in module '${data.module}'.`,\n\t\t\t\t\t\t`The wrapper for '${data.target}' registered by module '${data.module}' with type WRAPPER did not chain the call to the next wrapper, which breaks a libWrapper API requirement. This wrapper will be unregistered.`,\n\t\t\t\t\t\t'error'\n\t\t\t\t\t);\n\n\t\t\t\t\tglobalThis.libWrapper.unregister(data.module, data.target);\n\n\t\t\t\t\t// Manually chain to the next wrapper if there are more in the chain\n\t\t\t\t\tif(!is_last_wrapper)\n\t\t\t\t\t\tresult = next_fn.apply(obj, args);\n\t\t\t\t}\n\n\t\t\t\t// Other TYPES get a generic 'conflict' message\n\t\t\t\telse if(!data.warned_conflict && !is_last_wrapper) {\n\t\t\t\t\tLibWrapperNotifications.conflict(data.module, affectedModules, true, `Module '${data.module}' did not chain the wrapper for '${data.target}'.`);\n\t\t\t\t\tdata.warned_conflict = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfinally {\n\t\t\t// Invalidate state to avoid asynchronous calls\n\t\t\tthis._invalidate_state(next_state);\n\t\t}\n\n\t\t// Done\n\t\treturn result;\n\t}\n\n\n\n\t// Non-property setter\n\tset_nonproperty(value, obj=null) {\n\t\tif(this.is_property)\n\t\t\tthrow new LibWrapperInternalError('Must not call \\'set_nonproperty\\' for a property wrapper.');\n\n\t\tconst inherited = (obj !== this.object);\n\n\t\t// If assigning to an instance directly, assign directly to instance\n\t\tif(inherited) {\n\t\t\tObject.defineProperty(obj, this.fn_name, {\n\t\t\t\tvalue: value,\n\t\t\t\tconfigurable: true,\n\t\t\t\tenumerable: true,\n\t\t\t\twritable: true\n\t\t\t});\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Wrap the new value\n\t\tthis._wrapped = value;\n\t\tthis._setter_call_count++;\n\n\t\t// Warn user and/or log conflict\n\t\tthis.warn_classic_wrapper();\n\t}\n\n\n\n\t// Conflict logging utilities\n\tget_affected_modules() {\n\t\tconst affectedModules = this.getter_data.map((x) => {\n\t\t\treturn x.module;\n\t\t});\n\n\t\treturn affectedModules;\n\t}\n\n\twarn_classic_wrapper() {\n\t\tlet module_name = get_current_module_name();\n\t\tmodule_name = module_name ? `\\u00AB${module_name}\\u00BB` : '\\u00ABunknown\\u00BB';\n\n\t\tconst affectedModules = this.get_affected_modules();\n\t\tLibWrapperStats.register_conflict(module_name, affectedModules, this.name);\n\n\t\tif(affectedModules.length > 0) {\n\t\t\tLibWrapperNotifications.conflict(module_name, affectedModules, true, `Detected non-libWrapper wrapping of '${this.name}' by ${module_name}. This will potentially lead to conflicts.`);\n\n\t\t\tif(DEBUG && console.trace)\n\t\t\t\tconsole.trace();\n\t\t}\n\n\t\tif(!this.detected_classic_wrapper)\n\t\t\tthis.detected_classic_wrapper = []\n\t\tthis.detected_classic_wrapper.push(module_name);\n\t}\n\n\n\n\t// Wraper array methods\n\t// NOTE: These should only ever be called from libWrapper, they do not clean up after themselves\n\tget_fn_data(setter, to_modify=false) {\n\t\tif(setter && !this.is_property)\n\t\t\tthrow new LibWrapperInternalError(`libWrapper: '${this.name}' does not wrap a property, thus setter=true is illegal.`);\n\n\t\tconst prop_nm = setter ? 'setter_data' : 'getter_data';\n\n\t\tif(to_modify && this._outstanding_wrappers > 0)\n\t\t\tthis[prop_nm] = this[prop_nm].slice(0);\n\n\t\treturn this[prop_nm];\n\t}\n\n\tsort() {\n\t\tfor(let setter of [false, true]) {\n\t\t\tif(setter && !this.is_property)\n\t\t\t\tcontinue;\n\n\t\t\tlet fn_data = this.get_fn_data(setter);\n\t\t\tfn_data.sort((a,b) => { return a.type - b.type || b.priority - a.priority });\n\t\t}\n\t}\n\n\tadd(data) {\n\t\t// Try to set a function name if there is none already\n\t\tconst fn = data.fn;\n\t\tif(!fn.name || fn.name === 'anonymous')\n\t\t\tset_function_name(fn, this._callstack_name(data.module ?? '<unknown>'));\n\n\t\t// Add to fn_data\n\t\tconst fn_data = this.get_fn_data(data.setter, true);\n\n\t\tfn_data.splice(0, 0, data);\n\t\tthis.sort(data.setter);\n\t}\n\n\tremove(data) {\n\t\tconst fn_data = this.get_fn_data(data.setter, true);\n\n\t\tconst index = fn_data.indexOf(data);\n\t\tfn_data.splice(index, 1);\n\t}\n\n\tclear() {\n\t\tthis.getter_data = [];\n\n\t\tif(this.is_property)\n\t\t\tthis.setter_data = [];\n\t}\n\n\tis_empty() {\n\t\treturn !this.getter_data.length && !this.setter_data?.length;\n\t}\n};\nObject.freeze(Wrapper);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {MODULE_ID, MODULE_TITLE, VERSION, TYPES_REVERSE} from '../consts.js';\nimport {LibWrapperStats} from './stats.js';\nimport {WRAPPERS} from '../utils/misc.js';\n\n\nexport class LibWrapperSettings extends FormApplication {\n\tstatic init() {\n\t\tgame.settings.register(MODULE_ID, 'notify-issues-gm', {\n\t\t\tname: 'Notify GM of Issues',\n\t\t\tdefault: true,\n\t\t\ttype: Boolean,\n\t\t\tscope: 'world',\n\t\t\tconfig: true,\n\t\t\thint: 'Whether to notify GMs when an issue is detected, for example a conflict.'\n\t\t});\n\n\t\tgame.settings.register(MODULE_ID, 'notify-issues-player', {\n\t\t\tname: 'Notify Players of Issues',\n\t\t\tdefault: false,\n\t\t\ttype: Boolean,\n\t\t\tscope: 'world',\n\t\t\tconfig: true,\n\t\t\thint: 'Whether to notify Players when an issue is detected, for example a conflict.'\n\t\t});\n\n\t\tgame.settings.registerMenu(MODULE_ID, 'menu', {\n\t\t\tname: '',\n\t\t\tlabel: `${MODULE_TITLE} Settings Menu`,\n\t\t\ticon: \"fas fa-cog\",\n\t\t\ttype: LibWrapperSettings,\n\t\t\trestricted: true\n\t\t});\n\n\t\tgame.settings.register(MODULE_ID, 'module-priorities', {\n\t\t\tname: '',\n\t\t\tdefault: {},\n\t\t\ttype: Object,\n\t\t\tscope: 'world',\n\t\t\tconfig: false,\n\t\t\tonChange: value => globalThis.libWrapper.load_priorities()\n\t\t});\n\t}\n\n\n\t// Settings UI\n\tstatic get defaultOptions() {\n\t\treturn {\n\t\t\t...super.defaultOptions,\n\t\t\ttemplate: `modules/${MODULE_ID}/templates/settings.html`,\n\t\t\theight: 700,\n\t\t\ttitle: `${MODULE_TITLE} Settings Menu`,\n\t\t\twidth: 600,\n\t\t\tclasses: [MODULE_ID, \"settings\"],\n\t\t\ttabs: [\n\t\t\t\t{\n\t\t\t\t\tnavSelector: '.tabs',\n\t\t\t\t\tcontentSelector: 'form',\n\t\t\t\t\tinitial: 'name'\n\t\t\t\t}\n\t\t\t],\n\t\t\tsubmitOnClose: false,\n\t\t\tcloseOnSubmit: false\n\t\t}\n\t}\n\n\tconstructor(object = {}, options) {\n\t\tsuper(object, options);\n\t}\n\n\tstatic showYesNoDialog(msg, yes_callback) {\n\t\tnew Dialog({\n\t\t\tcontent: msg,\n\t\t\tbuttons: {\n\t\t\t\tyes: {\n\t\t\t\t\ticon: '<i class=\"fas fa-check\"></i>',\n\t\t\t\t\tlabel: 'Yes',\n\t\t\t\t\tcallback: yes_callback\n\t\t\t\t},\n\t\t\t\tno: {\n\t\t\t\t\ticon: '<i class=\"fas fa-times\"></i>',\n\t\t\t\t\tlabel: 'No'\n\t\t\t\t}\n\t\t\t}\n\t\t}).render(true);\n\t}\n\n\tgetActiveWrappers() {\n\t\tlet data = [];\n\n\t\tWRAPPERS.forEach((wrapper) => {\n\t\t\tfor(let is_setter of [false, true]) {\n\t\t\t\tif(is_setter && !wrapper.is_property)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tlet name = wrapper.name;\n\t\t\t\tif(is_setter)\n\t\t\t\t\tname = `${name}#set`;\n\n\t\t\t\tlet _d = {\n\t\t\t\t\tname  : name,\n\t\t\t\t\tmodules: []\n\t\t\t\t};\n\n\t\t\t\twrapper.get_fn_data(is_setter).forEach((fn_data) => {\n\t\t\t\t\tif(fn_data.module == MODULE_ID)\n\t\t\t\t\t\treturn;\n\n\t\t\t\t\t_d.modules.push({\n\t\t\t\t\t\tname    : fn_data.module,\n\t\t\t\t\t\ttype    : TYPES_REVERSE[fn_data.type]\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\tif(wrapper.detected_classic_wrapper) {\n\t\t\t\t\twrapper.detected_classic_wrapper.forEach((module) => {\n\t\t\t\t\t\t_d.modules.push({\n\t\t\t\t\t\t\tname    : module,\n\t\t\t\t\t\t\ttype    : 'MANUAL'\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif(_d.modules.length > 0)\n\t\t\t\t\tdata.push(_d);\n\t\t\t}\n\t\t});\n\n\t\tdata.sort((a,b) => b.modules.length - a.modules.length);\n\n\t\treturn data;\n\t}\n\n\tgetConflicts() {\n\t\tif(!LibWrapperStats.collect_stats)\n\t\t\treturn null;\n\n\t\tlet data = [];\n\n\t\tLibWrapperStats.conflicts.forEach((conflict) => {\n\t\t\tlet targets = [];\n\n\t\t\tdata.push({\n\t\t\t\tcount: conflict.count,\n\t\t\t\tmodule: conflict.module,\n\t\t\t\tother: conflict.other,\n\t\t\t\ttargets: targets\n\t\t\t});\n\n\t\t\tconflict.targets.forEach((count, target) => {\n\t\t\t\ttargets.push({target: target, count: count});\n\t\t\t});\n\n\t\t\ttargets.sort((a,b) => a.count - b.count);\n\t\t});\n\n\t\tdata.sort((a,b) => a.count - b.count);\n\n\t\treturn data;\n\t}\n\n\tgetModules() {\n\t\tlet data = {\n\t\t\tprioritized: [],\n\t\t\tnormal: [],\n\t\t\tdeprioritized: []\n\t\t};\n\n\t\tconst priorities = game.settings.get(MODULE_ID, 'module-priorities');\n\t\tconst cfg_prioritized   = priorities.prioritized   ?? {};\n\t\tconst cfg_deprioritized = priorities.deprioritized ?? {};\n\n\t\t// Normal modules\n\t\tif(LibWrapperStats.collect_stats) {\n\t\t\tLibWrapperStats.modules.forEach((module_id) => {\n\t\t\t\tconst module_data = game.modules.get(module_id).data;\n\n\t\t\t\tif(module_id in cfg_prioritized || module_id in cfg_deprioritized)\n\t\t\t\t\treturn;\n\n\t\t\t\tdata.normal.push({\n\t\t\t\t\tid: module_id,\n\t\t\t\t\ttitle: module_data.title\n\t\t\t\t});\n\t\t\t});\n\t\t\tdata.normal.sort((a,b) => {return a.id - b.id});\n\t\t}\n\n\t\t// Prioritized modules\n\t\tObject.entries(cfg_prioritized).forEach((entry) => {\n\t\t\tconst [module_id, module_info] = entry;\n\t\t\tconst module_data = game.modules.get(module_id)?.data;\n\n\t\t\tdata.prioritized.push({\n\t\t\t\tid: module_id,\n\t\t\t\ttitle: module_data?.title ?? `${module_info.title} <Inactive>`,\n\t\t\t\tindex: module_info.index\n\t\t\t});\n\t\t});\n\t\tdata.prioritized.sort((a,b) => { return a.index - b.index });\n\n\t\t// Deprioritized modules\n\t\tObject.entries(cfg_deprioritized).forEach((entry) => {\n\t\t\tconst [module_id, module_info] = entry;\n\n\t\t\t// In case something went wrong and we have a duplicate module\n\t\t\tif(module_id in cfg_prioritized)\n\t\t\t\treturn;\n\n\t\t\tconst module_data = game.modules.get(module_id)?.data;\n\n\t\t\tdata.deprioritized.push({\n\t\t\t\tid: module_id,\n\t\t\t\ttitle: module_data?.title ?? `${module_info.title} <Inactive>`,\n\t\t\t\tindex: module_info.index\n\t\t\t});\n\t\t});\n\t\tdata.deprioritized.sort((a,b) => { return a.index - b.index });\n\n\t\t// Done\n\t\treturn data;\n\t}\n\n\tgetData() {\n\t\tlet data = {\n\t\t\tabout: {\n\t\t\t\tname: MODULE_TITLE,\n\t\t\t\tversion: VERSION,\n\t\t\t\tcollect_stats: LibWrapperStats.collect_stats\n\t\t\t},\n\n\t\t\twrappers: this.getActiveWrappers(),\n\t\t\tconflicts: this.getConflicts(),\n\t\t\tmodules: this.getModules()\n\t\t};\n\n\t\treturn data;\n\t}\n\n\tactivateListeners(html) {\n\t\tsuper.activateListeners(html);\n\n\t\tlet _this = this;\n\n\t\t// Tree view\n\t\thtml.find('.caret.has-nested').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\t$this.parent().find('.nested').toggleClass('active');\n\t\t\t$this.toggleClass('caret-down');\n\t\t});\n\n\t\t// Reload button\n\t\thtml.find('button#reload').on('click', function(event) {\n\t\t\t_this.render(true);\n\t\t});\n\n\t\t// Easily focus the priority groups\n\t\thtml.find('.module-priority-group').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\tconst select = $this.find('select');\n\n\t\t\tif(!select.is(':focus'))\n\t\t\t\tselect.focus();\n\t\t});\n\n\t\t// Change priority buttons\n\t\thtml.find('button.change-priority').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\tconst which = $this.data('which');\n\t\t\tconst direction = $this.data('direction');\n\t\t\tconst up = (direction === 'up');\n\n\t\t\tconst list = html.find(`#${which}`);\n\t\t\tconst selected = list.find('option:selected');\n\n\t\t\tconst insertPos = up ? selected.prev() : selected.next();\n\n\t\t\tif(!insertPos.length)\n\t\t\t\treturn;\n\n\t\t\tif(up)\n\t\t\t\tinsertPos.before(selected);\n\t\t\telse\n\t\t\t\tinsertPos.after(selected);\n\t\t});\n\n\t\t// Change category buttons\n\t\thtml.find('button.change-category').on('click', function(event) {\n\t\t\tconst $this = $(this);\n\n\t\t\tconst _from = $this.data('from');\n\t\t\tconst _to = $this.data('to');\n\n\t\t\tconst from = html.find(`#${_from}`);\n\t\t\tconst to = html.find(`#${_to}`);\n\n\t\t\tconst element = from.find('option:selected');\n\n\t\t\t// Search for the element to focus next\n\t\t\tlet next_focus = element.next();\n\t\t\tif(next_focus.length == 0)\n\t\t\t\tnext_focus = element.prev();\n\n\t\t\t// Move to the destination list\n\t\t\tto.append(element);\n\n\t\t\t// If the destination was the 'normal', we need to sort it alphabetically\n\t\t\tif(_to == 'modules-normal') {\n\t\t\t\tconst options = to.find('option');\n\t\t\t\toptions.sort((a,b) => { return $(a).val() > $(b).val() ? 1 : -1 });\n\t\t\t\tto.empty().append(options);\n\t\t\t}\n\n\t\t\t// Focus the previous list again\n\t\t\tif(next_focus.length)\n\t\t\t\tfrom.val(next_focus.val());\n\n\t\t\tfrom.focus();\n\t\t});\n\n\t\t// Submit 'Priorities'\n\t\thtml.find('#submit').on('click', function(event) {\n\t\t\t// Collect prioritization order into hidden fields that will be submitted\n\t\t\tfor(let type of ['modules-prioritized', 'modules-deprioritized']) {\n\t\t\t\tconst select = html.find(`#${type}`);\n\n\t\t\t\tconst options = select.find('option');\n\n\t\t\t\tlet arr = [];\n\t\t\t\toptions.each((i, option) => {\n\t\t\t\t\tarr.push($(option).val());\n\t\t\t\t});\n\n\t\t\t\t$('<input>').attr('type', 'hidden').attr('name', `${type}-hidden`).attr('value', arr.join(',')).appendTo(html);\n\t\t\t}\n\n\t\t\thtml.submit();\n\t\t});\n\n\t\t// Reset button\n\t\thtml.find('#reset').on('click', function(event) {\n\t\t\t$('input[type=hidden]').remove();\n\n\t\t\tLibWrapperSettings.showYesNoDialog(\"<p>Resetting the module priorities will move all modules back to 'Unprioritized'. This action cannot be undone. Are you sure you want to continue?</p>\", () => {\n\t\t\t\tfor(let type of ['modules-prioritized', 'modules-deprioritized']) {\n\t\t\t\t\t$('<input>').attr('type', 'hidden').attr('name', `${type}-hidden`).attr('value', '').appendTo(html);\n\t\t\t\t}\n\n\t\t\t\thtml.submit();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync _updateObject(ev, formData) {\n\t\t// Parse priorities\n\t\tconst priorities = game.settings.get(MODULE_ID, 'module-priorities');\n\n\t\tfor(let type of ['prioritized', 'deprioritized']) {\n\t\t\tconst fld = `modules-${type}-hidden`;\n\n\t\t\tif(!(fld in formData))\n\t\t\t\tcontinue;\n\n\t\t\tconst value = formData[fld];\n\t\t\tconst split = (value === '') ? [] : value.split(',');\n\n\t\t\tlet old_prio = priorities[type] ?? {};\n\t\t\tlet new_prio = {};\n\t\t\tlet counter = 0;\n\n\t\t\tsplit.forEach((module_id) => {\n\t\t\t\tif(!module_id)\n\t\t\t\t\treturn;\n\n\t\t\t\tconst old_data = old_prio[old_prio];\n\t\t\t\tconst new_data = game.modules.get(module_id)?.data;\n\n\t\t\t\tnew_prio[module_id] = {\n\t\t\t\t\ttitle: new_data?.title ?? old_data?.title ?? '<Unknown>',\n\t\t\t\t\tindex: counter++\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tpriorities[type] = new_prio;\n\t\t}\n\n\t\t// Sanity check for duplicates\n\t\tObject.keys(priorities.deprioritized).forEach((key) => {\n\t\t\tif(key in priorities.prioritized)\n\t\t\t\tdelete priorities.deprioritized[key];\n\t\t});\n\n\t\t// Save\n\t\tawait game.settings.set(MODULE_ID, 'module-priorities', priorities);\n\n\t\t// Re-render\n\t\tthis.render(true);\n\n\t\t// Ask user to refresh page\n\t\tLibWrapperSettings.showYesNoDialog(\"<p>It is recommended you reload this page to apply the new module priorities. Do you wish to reload?</p>\", () => location.reload());\n\t}\n}\nObject.freeze(LibWrapperSettings);","// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright ¬© 2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\nimport {MODULE_ID, MAJOR_VERSION, MINOR_VERSION, PATCH_VERSION, SUFFIX_VERSION, VERSION, parse_manifest_version, IS_UNITTEST, PROPERTIES_CONFIGURABLE, DEBUG, setDebug, TYPES, TYPES_REVERSE, TYPES_LIST} from '../consts.js';\nimport {Wrapper} from './wrapper.js';\nimport {LibWrapperError, LibWrapperModuleError, LibWrapperAlreadyOverriddenError, LibWrapperInvalidWrapperChainError, LibWrapperInternalError} from '../utils/errors.js';\nimport {get_global_variable, get_current_module_name, WRAPPERS, set_function_name} from '../utils/misc.js';\nimport {LibWrapperNotifications} from '../ui/notifications.js'\nimport {LibWrapperStats} from '../ui/stats.js';\nimport {LibWrapperSettings} from '../ui/settings.js';\n\n// Local variables\nlet libwrapper_ready = false;\nlet allow_libwrapper_registrations = true;\n\n// Manager class\nexport const PRIORITIES = new Map();\n\nexport class libWrapper {\n\t// Properties\n\tstatic get version() { return VERSION; }\n\tstatic get versions() { return [MAJOR_VERSION, MINOR_VERSION, PATCH_VERSION, SUFFIX_VERSION]; }\n\tstatic get is_fallback() { return false; }\n\n\tstatic get debug() { return DEBUG; }\n\tstatic set debug(value) { setDebug(value) }\n\n\t// Errors\n\tstatic get LibWrapperError() { return LibWrapperError; };\n\tstatic get Error() { return LibWrapperError; }\n\n\tstatic get LibWrapperInternalError() { return LibWrapperInternalError; };\n\tstatic get InternalError() { return LibWrapperInternalError; }\n\n\tstatic get LibWrapperModuleError() { return LibWrapperModuleError; };\n\tstatic get ModuleError() { return LibWrapperModuleError; };\n\n\tstatic get LibWrapperAlreadyOverriddenError() { return LibWrapperAlreadyOverriddenError; };\n\tstatic get AlreadyOverriddenError() { return LibWrapperAlreadyOverriddenError; };\n\n\tstatic get LibWrapperInvalidWrapperChainError() { return LibWrapperInvalidWrapperChainError; };\n\tstatic get InvalidWrapperChainError() { return LibWrapperInvalidWrapperChainError; };\n\n\n\t// Variables\n\tstatic wrappers = WRAPPERS;\n\n\t// Utilities\n\tstatic _create_wrapper_from_object(obj, fn_name, name=undefined, module=undefined) {\n\t\tconst wrapper = new Wrapper(obj, fn_name, name, module);\n\t\tthis.wrappers.add(wrapper);\n\t\treturn wrapper;\n\t}\n\n\tstatic _split_target_and_setter(target) {\n\t\tlet is_setter = target.endsWith('#set');\n\t\tlet _target = !is_setter ? target : target.slice(0, -4);\n\n\t\treturn [_target, is_setter];\n\t}\n\n\tstatic _valid_identifier(ident) {\n\t\treturn /^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(ident);\n\t}\n\n\tstatic _get_target_object(_target, module=undefined) {\n\t\t// Parse the target\n\t\tconst target = this._split_target_and_setter(_target)[0];\n\n\t\tconst split = target.split('.');\n\t\tconst fn_name = split.pop();\n\n\t\t// Get root object\n\t\tconst root_nm = split.splice(0,1)[0];\n\t\tif(!this._valid_identifier(root_nm))\n\t\t\tthrow new LibWrapperModuleError(`Invalid target '${target}.'`, module);\n\t\tif(root_nm == 'libWrapper')\n\t\t\tthrow new LibWrapperModuleError(`Not allowed to wrap libWrapper internals.`, module);\n\n\t\tconst root = get_global_variable(root_nm);\n\t\tif(!root)\n\t\t\tthrow new LibWrapperModuleError(`Could not find target '${target}'.`, module);\n\n\t\t// Get target object\n\t\tlet obj = root;\n\t\tfor(let scope of split) {\n\t\t\tif(!this._valid_identifier(scope))\n\t\t\t\tthrow new LibWrapperModuleError(`Invalid target '${target}'.`, module);\n\n\t\t\tobj = obj[scope];\n\t\t\tif(!obj)\n\t\t\t\tthrow new LibWrapperModuleError(`Could not find target '${target}'.`, module);\n\t\t}\n\n\t\treturn [obj, fn_name, target];\n\t}\n\n\tstatic _create_wrapper(target, module=null) {\n\t\t// Create wrapper\n\t\treturn this._create_wrapper_from_object(...this._get_target_object(target), module);\n\t}\n\n\tstatic _find_wrapper_by_name(_name) {\n\t\tconst name = this._split_target_and_setter(_name)[0];\n\n\t\tfor(let wrapper of this.wrappers) {\n\t\t\tif(wrapper.names.indexOf(name) != -1)\n\t\t\t\treturn wrapper;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tstatic _find_module_data_in_wrapper(module, wrapper, is_setter) {\n\t\treturn wrapper.get_fn_data(is_setter).find((x) => { return x.module == module; });\n\t}\n\n\tstatic _find_module_data_with_target(module, _target) {\n\t\tconst target_and_setter = this._split_target_and_setter(_target);\n\t\tconst target    = target_and_setter[0];\n\t\tconst is_setter = target_and_setter[1];\n\n\t\tconst wrapper = this._find_wrapper_by_name(target);\n\t\tif(!wrapper)\n\t\t\treturn null;\n\n\t\treturn this._find_module_data_in_wrapper(module, wrapper, is_setter);\n\t}\n\n\tstatic _get_default_priority(module, target) {\n\t\tif(module === MODULE_ID)\n\t\t\treturn Number.MAX_VALUE;\n\n\t\tconst priority_cfg = PRIORITIES.get(module);\n\t\tif(priority_cfg !== undefined)\n\t\t\treturn priority_cfg;\n\n\t\treturn 0;\n\t}\n\n\n\tstatic _unwrap_if_possible(wrapper) {\n\t\tif(wrapper.is_empty() && PROPERTIES_CONFIGURABLE) {\n\t\t\twrapper.unwrap();\n\t\t\tthis.wrappers.delete(wrapper);\n\t\t}\n\t}\n\n\tstatic _clear(target) {\n\t\tconst wrapper = this._find_wrapper_by_name(target);\n\n\t\tif(wrapper) {\n\t\t\twrapper.clear();\n\t\t\tthis._unwrap_if_possible(wrapper);\n\n\t\t\tconsole.info(`libWrapper: Cleared all wrapper functions for '${target}'.`);\n\t\t}\n\t}\n\n\n\tstatic _unwrap_all() {\n\t\tfor(let wrapper of this.wrappers) {\n\t\t\twrapper.clear();\n\t\t\twrapper.unwrap();\n\t\t}\n\n\t\tthis.wrappers.clear();\n\t}\n\n\n\tstatic _validate_module(module) {\n\t\tconst real_module = get_current_module_name();\n\n\t\tif(!module || typeof module !== 'string')\n\t\t\tthrow new LibWrapperModuleError('Parameter \\'module\\' must be a string.', real_module);\n\n\t\tif(module != MODULE_ID && !game.modules.get(module)?.active)\n\t\t\tthrow new LibWrapperModuleError(`Module '${module}' is not a valid module.`, real_module);\n\n\t\tif(module == MODULE_ID && !allow_libwrapper_registrations)\n\t\t\tthrow new LibWrapperModuleError(`Not allowed to call libWrapper with module='${module}'.`, real_module);\n\n\t\tif(real_module && module != real_module)\n\t\t\tthrow new LibWrapperModuleError(`Module '${real_module}' is not allowed to call libWrapper with module='${module}'.`, real_module);\n\t}\n\n\n\tstatic load_priorities(value=null) {\n\t\tconst module = get_current_module_name();\n\t\tif(module)\n\t\t\tthrow new LibWrapperModuleError(`Module '${module}' is not allowed to call libWrapper.load_priorities()`, module);\n\n\t\t// Create existing priorities\n\t\tPRIORITIES.clear();\n\n\t\t// Parse config\n\t\tconst priority_cfg = value ?? game?.settings?.get(MODULE_ID, 'module-priorities');\n\t\tif(!priority_cfg)\n\t\t\treturn;\n\n\t\tfor(let type of ['prioritized', 'deprioritized']) {\n\t\t\tconst current = priority_cfg[type];\n\t\t\tif(!current)\n\t\t\t\tcontinue;\n\n\t\t\tconst base_priority = (type == 'prioritized') ? 10000 : -10000;\n\n\t\t\tObject.entries(current).forEach(entry => {\n\t\t\t\tconst [module_id, module_info] = entry;\n\n\t\t\t\tif(PRIORITIES.has(module_id))\n\t\t\t\t\treturn;\n\n\t\t\t\tPRIORITIES.set(module_id, base_priority - module_info.index);\n\t\t\t});\n\t\t}\n\t}\n\n\n\t// Public interface\n\n\t/**\n\t * Register a new wrapper.\n\t * Important: If called before the 'init' hook, this method will fail.\n\t *\n\t * In addition to wrapping class methods, there is also support for wrapping methods on specific object instances, as well as class methods inherited from parent classes.\n\t * However, it is recommended to wrap methods directly in the class that defines them whenever possible, as inheritance/instance wrapping is less thoroughly tested and will incur a performance penalty.\n\t *\n\t * @param {string} module  The module identifier, i.e. the 'name' field in your module's manifest.\n\t * @param {string} target  A string containing the path to the function you wish to add the wrapper to, starting at global scope, for example 'SightLayer.prototype.updateToken'.\n\t *                         This works for both normal methods, as well as properties with getters. To wrap a property's setter, append '#set' to the name, for example 'SightLayer.prototype.blurDistance#set'.\n\t * @param {function} fn    Wrapper function. The first argument will be the next function in the chain, except for 'OVERRIDE' wrappers.\n\t *                         The remaining arguments will correspond to the parameters passed to the wrapped method.\n\t * @param {string} type    [Optional] The type of the wrapper. Default is 'MIXED'. The possible types are:\n\t *\n\t *   'WRAPPER':\n\t *     Use if your wrapper will *always* call the next function in the chain.\n\t *     This type has priority over every other type. It should be used whenever possible as it massively reduces the likelihood of conflicts.\n\t *     Note that the library will auto-detect if you use this type but do not call the original function, and automatically unregister your wrapper.\n\t *\n\t *   'MIXED':\n\t *     Default type. Your wrapper will be allowed to decide whether it should call the next function in the chain or not.\n\t *     These will always come after 'WRAPPER'-type wrappers. Order is not guaranteed, but conflicts will be auto-detected.\n\t *\n\t *   'OVERRIDE':\n\t *     Use if your wrapper will *never* call the next function in the chain. This type has the lowest priority, and will always be called last.\n\t *     If another module already has an 'OVERRIDE' wrapper registered to the same method, using this type will throw a <libWrapper.LibWrapperAlreadyOverriddenError> exception.\n\t *     Catching this exception should allow you to fail gracefully, and for example warn the user of the conflict.\n\t *     Note that if the GM has explicitly given your module priority over the existing one, no exception will be thrown and your wrapper will take over.\n\t *\n\t *\n\t */\n\tstatic register(module, target, fn, type='MIXED') {\n\t\t// Validate module\n\t\tthis._validate_module(module);\n\n\t\t// Validate we're allowed to register wrappers at this moment\n\t\tif(module != MODULE_ID && !libwrapper_ready)\n\t\t\tthrow new LibWrapperModuleError('Not allowed to register wrappers before the \\'libWrapperReady\\' hook fires', module);\n\n\t\t// Validate other arguments\n\t\tif(!target || typeof target !== 'string')\n\t\t\tthrow new LibWrapperModuleError('Parameter \\'target\\' must be a string.', module);\n\n\t\tif(!fn || !(fn instanceof Function))\n\t\t\tthrow new LibWrapperModuleError('Parameter \\'fn\\' must be a function.', module);\n\n\t\ttype = TYPES[type.toUpperCase()];\n\t\tif(typeof type === 'undefined' || !(type in TYPES_REVERSE))\n\t\t\tthrow new LibWrapperModuleError(`Parameter 'type' must be one of [${TYPES_LIST.join(', ')}].`, module);\n\n\t\t// Split '#set' from the target\n\t\tconst target_and_setter  = this._split_target_and_setter(target);\n\t\tconst target_without_set = target_and_setter[0];\n\t\tconst is_setter          = target_and_setter[1];\n\n\t\t// Create wrapper\n\t\tlet wrapper = this._create_wrapper(target, module);\n\n\t\t// Only allow '#set' when the wrapper is wrapping a property\n\t\tif(is_setter && !wrapper.is_property)\n\t\t\tthrow new LibWrapperModuleError(`Cannot register a wrapper for '${target}' by '${module}' because '${target_without_set}' is not a property, and therefore has no setter.`, module);\n\n\t\t// Check if this wrapper is already registered\n\t\tif(this._find_module_data_in_wrapper(module, wrapper, is_setter))\n\t\t\tthrow new LibWrapperModuleError(`Module '${module}' has already registered a wrapper for '${target}'.`, module);\n\n\t\t// Get priority\n\t\tconst priority = this._get_default_priority(module, target);\n\n\t\t// Only allow one 'OVERRIDE' type\n\t\tif(type == TYPES.OVERRIDE) {\n\t\t\tconst existing = wrapper.get_fn_data(is_setter).find((x) => { return x.type == TYPES.OVERRIDE });\n\n\t\t\tif(existing) {\n\t\t\t\tif(priority <= existing.priority) {\n\t\t\t\t\tthrow new LibWrapperAlreadyOverriddenError(module, existing.module, wrapper.name);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tLibWrapperStats.register_conflict(module, existing.module, wrapper.name);\n\t\t\t\t\tLibWrapperNotifications.conflict(existing.module, module, false,\n\t\t\t\t\t\t`Module '${module}' has higher priority, and is replacing the OVERRIDE registered by '${existing.module}' for '${wrapper.name}'.`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Register this module as having wrapped something\n\t\tif(module != MODULE_ID)\n\t\t\tLibWrapperStats.register_module(module);\n\n\t\t// Wrap\n\t\tlet data = {\n\t\t\tmodule  : module,\n\t\t\ttarget  : target,\n\t\t\tsetter  : is_setter,\n\t\t\tfn      : fn,\n\t\t\ttype    : type,\n\t\t\twrapper : wrapper,\n\t\t\tpriority: priority\n\t\t};\n\n\t\twrapper.add(data);\n\n\t\t// Done\n\t\tif(DEBUG || module != MODULE_ID)\n\t\t\tconsole.info(`libWrapper: Registered a wrapper for '${target}' by '${module}' with type ${TYPES_REVERSE[type]}.`);\n\t}\n\n\t/**\n\t * Unregister an existing wrapper.\n\t *\n\t * @param {string} module    The module identifier, i.e. the 'name' field in your module's manifest.\n\t * @param {string} target    A string containing the path to the function you wish to remove the wrapper from, starting at global scope. For example: 'SightLayer.prototype.updateToken'\n\t * @param {function} fail    [Optional] If true, this method will throw an exception if it fails to find the method to unwrap. Default is 'true'.\n\t */\n\tstatic unregister(module, target, fail=true) {\n\t\t// Validate module\n\t\tthis._validate_module(module);\n\n\t\t// Find wrapper\n\t\tconst data = this._find_module_data_with_target(module, target);\n\t\tif(!data) {\n\t\t\tif(fail)\n\t\t\t\tthrow new LibWrapperModuleError(`Cannot unregister '${target}' by '${module}' as no such wrapper has been registered`, module);\n\t\t\treturn;\n\t\t}\n\n\t\tconst wrapper = data.wrapper;\n\n\t\t// Remove from fn_data\n\t\twrapper.remove(data);\n\t\tthis._unwrap_if_possible(wrapper);\n\n\t\t// Done\n\t\tif(DEBUG || module != MODULE_ID)\n\t\t\tconsole.info(`libWrapper: Unregistered the wrapper for '${target}' by '${module}'.`);\n\t}\n\n\t/**\n\t * Clear all wrappers created by a given module.\n\t *\n\t * @param {string} module    The module identifier, i.e. the 'name' field in your module's manifest.\n\t */\n\tstatic clear_module(module) {\n\t\t// Validate module\n\t\tthis._validate_module(module);\n\n\t\t// Clear module wrappers\n\t\tfor(let wrapper of this.wrappers) {\n\t\t\tthis.unregister(module, wrapper.name, false);\n\n\t\t\tif(wrapper.is_property)\n\t\t\t\tthis.unregister(module, `${wrapper.name}#set`, false);\n\t\t}\n\n\t\tconsole.info(`libWrapper: Cleared all wrapper functions by module '${module}'.`);\n\t}\n};\nObject.freeze(libWrapper);\n\n\n// Define as property so that it can't be deleted\ndelete globalThis.libWrapper;\nObject.defineProperty(globalThis, 'libWrapper', {\n\tget: () => libWrapper,\n\tset: (value) => { throw `libWrapper: Not allowed to re-assign the global instance of libWrapper` },\n\tconfigurable: false\n});\n\n\n// Initialize libWrapper right before the 'init' hook. Unit tests just initialize immediately\n{\n\tconst libWrapperInit = function(wrapped, ...args) {\n\t\t// Notify everyone the library has loaded and is ready to start registering wrappers\n\t\tlibwrapper_ready = true;\n\n\t\tparse_manifest_version();\n\t\tLibWrapperSettings.init();\n\t\tLibWrapperStats.init();\n\t\tLibWrapperNotifications.init();\n\t\tlibWrapper.load_priorities();\n\n\t\tconsole.info(`libWrapper ${VERSION}: Ready.`);\n\t\tHooks.callAll('libWrapperReady', libWrapper);\n\n\t\tconst result = wrapped(...args);\n\n\t\treturn result;\n\t}\n\n\tif(!IS_UNITTEST)\n\t\tlibWrapper.register('lib-wrapper', 'Game.prototype.initialize', libWrapperInit, 'WRAPPER');\n\telse\n\t\tlibWrapperInit(()=>{});\n}\n\n\n// Lock down registrations using module 'lib-wrapper'\nallow_libwrapper_registrations = false;"],"names":["MODULE_ID","VERSION","MAJOR_VERSION","MINOR_VERSION","PATCH_VERSION","SUFFIX_VERSION","IS_UNITTEST","Game","PROPERTIES_CONFIGURABLE","DEBUG","TYPES_LIST","Object","freeze","TYPES","WRAPPER","MIXED","OVERRIDE","TYPES_REVERSE","key","get_current_module_name","stack_trace","Error","stack","matches","matchAll","match","game","modules","has","__eval_copy","eval","set_function_name","fn","name","defineProperty","value","writable","enumerable","configurable","e","WRAPPERS","Set","LibWrapperNotifications","_game2","user","_game2$user","isGM","_game3","settings","_game3$settings","get","_game4","_game4$settings","msg","this","ui_enabled","NOTIFICATION_SET","add","notify","ui","_ui","notifications","call","permanent","ui_msg","console_msg","console","module","other","potential","startsWith","endsWith","Array","isArray","length","join","console_ui","LibWrapperError","constructor","notification_fn","args","captureStackTrace","onUnhandled","LibWrapperInternalError","LibWrapperModuleError","possibly","LibWrapperAlreadyOverriddenError","conflicting_module","target","_game$modules$get2","data","_game$modules$get2$da","title","LibWrapperStats","register_conflict","LibWrapperInvalidWrapperChainError","wrapper","_wrapper","onUnhandledError","apply","warn","globalThis","addEventListener","userid","userId","users","find","x","_id","role","collect_stats","_collect_stats","MODULES","CONFLICTS","Map","forEach","m","count","targets","set","Wrapper","names","_callstack_name","nm","arg1","_callstack_call_wrapper_name","obj","fn_name","object","descriptor","getOwnPropertyDescriptor","_descriptor$get","_lib_wrapper","_descriptor$get2","indexOf","push","is_property","_wrapped_getter","_wrapped_setter","_wrapped","_get_inherited_descriptor","_descriptor$get3","getter_data","setter_data","active","_outstanding_wrappers","_warned_detected_classic_wrapper","_pending_original_calls","_setter_call_count","_wrap","_get_handler","_this","setter_call_count","handler_nm","wrapped","should_skip_wrappers","get_wrapped","call_wrapper","bind","getter_nm","setter_nm","setter","set_nonproperty","getter","debug","unwrap","iObj","getPrototypeOf","result","undefined","_call_wrapped","is_setter","pend","_cleanup_call_wrapped","_result","then","v","pend_i","splice","state","index","fn_data","valid","prev_data","_state$prev_data","called","type","next_state","next_fn","_cleanup_call_wrapper_thrown","_result2","_cleanup_call_wrapper","_invalidate_state","collect_affected","warned_conflict","affectedModules","is_last_wrapper","slice","filter","map","libWrapper","unregister","conflict","warn_classic_wrapper","get_affected_modules","module_name","trace","detected_classic_wrapper","get_fn_data","to_modify","prop_nm","sort","a","b","priority","remove","clear","is_empty","_this$setter_data","LibWrapperSettings","FormApplication","register","default","Boolean","scope","config","hint","registerMenu","label","icon","restricted","onChange","load_priorities","super","defaultOptions","template","height","width","classes","tabs","navSelector","contentSelector","initial","submitOnClose","closeOnSubmit","options","yes_callback","Dialog","content","buttons","yes","callback","no","render","getActiveWrappers","_d","getConflicts","conflicts","getModules","prioritized","normal","deprioritized","priorities","cfg_prioritized","cfg_deprioritized","module_id","module_data","id","entries","entry","module_info","_game$modules$get3","_game$modules$get4","getData","about","version","wrappers","activateListeners","html","on","event","$this","$","parent","toggleClass","select","is","focus","which","up","selected","insertPos","prev","next","before","after","_from","_to","from","to","element","next_focus","append","val","empty","arr","each","i","option","attr","appendTo","submit","showYesNoDialog","ev","formData","fld","split","old_prio","new_prio","counter","old_data","new_data","_game$modules$get5","keys","location","reload","libwrapper_ready","allow_libwrapper_registrations","PRIORITIES","ident","test","_target","_split_target_and_setter","pop","root_nm","_valid_identifier","root","varname","get_global_variable","_create_wrapper_from_object","_get_target_object","_name","target_and_setter","_find_wrapper_by_name","_find_module_data_in_wrapper","Number","MAX_VALUE","priority_cfg","delete","_unwrap_if_possible","info","real_module","_game$modules$get6","_game5","_game5$settings","current","base_priority","_validate_module","Function","toUpperCase","target_without_set","_create_wrapper","_get_default_priority","existing","register_module","fail","_find_module_data_with_target","libWrapperInit","version_str","_game$modules","_game$modules$get","_game$modules$get$dat","parseInt","isNaN","parse_manifest_version","init","Hooks","callAll"],"mappings":"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"}